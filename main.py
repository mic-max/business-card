import math
import drawsvg as dw
from dataclasses import dataclass

@dataclass
class CardConfig:
    width: float = 88.9
    height: float = 50.8
    radius: float = 1.5
    margin: float = 10.0

@dataclass
class DovetailConfig:
    depth: float = 5.0
    count: int = 4
    angle_deg: float = 9.5
    small_height: float = 2.3
    blind_fraction: float = 1 / 3

@dataclass
class TextStyle:
    font: str = 'Times New Roman'
    title_size: float = 10
    domain_size: float = 5
    right_margin: float = 10
    bottom_margin: float = 4
    info_size: float = 4
    line_height: float = 4.5
    title_y: float = 12.6
    domain_y: float = 18.5

@dataclass
class LogoConfig:
    x: float = 10.5
    y: float = 18.4
    scale: float = 0.23

@dataclass
class LaserConfig:
    cut_style = {
        'fill': 'none',
        'stroke': 'black',
        'stroke_width': '0.001in'
    }
    etch_style = {
        'fill': 'grey',
        'stroke': 'none',
    }

def draw_dovetails(g: dw.Group, card: CardConfig, dovetail: DovetailConfig, laser: LaserConfig):
    def dovetail_pin(x, y, dx, small_h, large_h, depth):
        p = dw.Path(**laser.etch_style)
        p.M(x, y - small_h / 2)
        p.L(x + dx * depth, y - large_h / 2)
        p.L(x + dx * depth, y + large_h / 2)
        p.L(x, y + small_h / 2)
        p.Z()
        return p

    d = dovetail.depth * dovetail.blind_fraction
    g.append(dw.Rectangle(0, 0, d + 0.05, card.height, **laser.etch_style))
    g.append(dw.Rectangle(card.width - d - 0.05, 0, d + 0.05, card.height, **laser.etch_style))

    # Draw the pins
    large_h = dovetail.small_height + 2 * (dovetail.depth * math.tan(math.radians(dovetail.angle_deg)))
    spacing = (card.height - dovetail.small_height) / (dovetail.count - 1)
    for i in range(dovetail.count):
        y = (dovetail.small_height / 2) + (i * spacing)
        g.append(dovetail_pin(card.width - d, y, -1, dovetail.small_height, large_h, dovetail.depth))
        g.append(dovetail_pin(d, y, 1, dovetail.small_height, large_h, dovetail.depth))

def draw_card_outline(card: CardConfig, laser: LaserConfig):
    # Create rounded rectangle clipping group
    clip = dw.ClipPath()
    clip.append(dw.Rectangle(0, 0, card.width, card.height, rx=card.radius, ry=card.radius))
    g = dw.Group(clip_path=clip)
    g.append(dw.Rectangle(0, 0, card.width, card.height, rx=card.radius, ry=card.radius, **laser.cut_style))
    return g

def make_card(
        card=CardConfig(),
        dovetail=DovetailConfig(),
        text=TextStyle(),
        logo=LogoConfig(),
        laser=LaserConfig()
    ):
    d = dw.Drawing(card.width, card.height, origin=(0, 0))
    g = draw_card_outline(card, laser)
    draw_dovetails(g, card, dovetail, laser)

    # Add company name
    x = card.width - text.right_margin
    d.append(dw.Text('Maxwell Made', text.title_size, x, text.title_y, text_anchor='end', font_family=text.font, **laser.etch_style, style='font-feature-settings: \'smcp\';'))
    d.append(dw.Text('.ca', text.domain_size, x, y=text.domain_y, text_anchor='end', font_family=text.font, **laser.etch_style))

    lines = [
        'Michael Maxwell',
        'Furniture Maker',
        'Ottawa, ON',
        '613 324 3802',
    ]

    for i, line in enumerate(reversed(lines)):
        y = card.height - text.bottom_margin - i * text.line_height
        d.append(dw.Text(line, text.info_size, x, y, text_anchor='end', font_family=text.font, **laser.etch_style, style='font-feature-settings: \'smcp\';'))

    group = dw.Group(transform=f'translate({logo.x}, {logo.y}) scale({logo.scale})')
    # TODO: load these paths by id from logo.svg
    cut_paths = [
        "m 67.053426,118.1525 c -0.744105,2.3583 -2.172414,3.40828 -3.206852,9.94301 -0.228012,1.12979 -1.288349,1.46192 -3.048952,0.90671 -1.090566,-0.25233 -1.614224,-0.46563 -1.293396,-1.7285 0.478588,-1.46481 1.636605,-1.73852 1.941095,-2.52228 0.889852,-1.5396 1.338118,-3.16112 1.353059,-6.79855 0.321993,-2.73173 1.066727,-3.6409 1.750765,-4.80346 1.356496,0.26523 3.354288,0.2517 4.13093,0.44813 -0.685926,2.74417 -1.420065,3.33404 -1.626649,4.55494 z",
        "m 110.4166,92.56436 c 3.07014,2.08322 10.84283,0.358083 13.55236,2.379621 2.71085,2.314735 6.99346,-0.773611 7.62759,1.876023 -2.05815,1.665875 -5.64104,-0.122812 -8.26654,2.739815 -2.51425,1.665841 -5.49465,-0.135764 -6.74992,3.404601 -1.82129,3.14876 -7.58377,4.12546 -10.30055,7.7001 -3.65852,2.21768 -7.402329,-0.7825 -11.052123,-0.28213 -2.427076,1.03651 -2.248779,8.18036 -5.580575,4.19537 -1.293554,-1.4578 -8.927844,-2.7359 -3.676152,-3.85615 10.00994,-4.1374 17.91583,-12.38909 21.82828,-21.711581 0.12616,-1.28698 2.5886,2.127065 2.61763,3.554331 z",
        "m 100.80151,47.384396 c 2.20372,-3.824662 4.38655,2.37947 7.46417,0.30453 1.62773,-3.829963 7.2187,-8.251603 5.67672,-3.394801 -1.58184,4.863584 3.71567,3.559307 4.36875,0.346796 1.87701,-3.191464 6.61529,-2.890904 6.10813,-0.583511 0.45817,1.18506 5.71211,-0.402012 7.83997,-4.142485 1.34873,-1.421558 2.7902,-1.568188 4.64192,-1.965298 0.23508,2.153036 -1.1407,2.928016 -2.63126,4.161856 -1.08348,2.246404 -3.2644,2.163522 -4.27347,5.039788 -1.61657,1.954547 -4.4547,4.598731 -1.6916,6.700514 -0.86921,2.925381 -5.08969,0.581708 -7.28771,2.7806 -1.31295,2.136944 -1.8562,4.868962 0.26322,6.62841 1.50094,1.954786 5.08936,2.296691 7.53125,3.134765 2.37938,2.399988 -2.76509,0.495193 -4.71903,1.802338 -0.95251,2.631924 -5.72512,0.116584 -6.80057,3.274981 -1.03462,1.847316 -4.87171,3.880538 -6.44713,3.838111 0.34837,-11.240723 -3.43443,-20.016481 -9.84774,-28.100454",
        "m 52.261275,22.647283 c -1.124426,-1.766329 -4.679586,-10.488428 -0.691102,-7.707668 3.285428,2.478642 7.960012,7.048289 12.803262,5.081451 2.642988,-11.0477153 3.836348,-4.976849 6.973526,-5.879442 3.199958,-1.979721 1.352004,-6.5977103 4.363434,-8.0093464 2.370103,3.6612815 -1.143793,11.3180994 6.307693,8.8073304 3.809189,2.012815 0.501828,12.264101 6.209946,10.061704 1.783685,0.388421 7.705318,-9.869623 9.564753,-6.303012 -0.643079,4.421604 -2.32442,10.188243 -3.935546,14.124564 -2.515941,7.271383 -3.220457,6.07444 -3.220457,6.07444 C 77.842401,31.40654 63.959586,32.697911 52.834828,37.820386 50.043265,32.252131 55.155974,27.357784 52.261275,22.647283 Z",
        "M 31.363452,80.237809 C 29.006205,67.536794 34.263427,53.37329 42.219267,45.70769 c -1.04377,-4.346554 -6.352696,1.958031 -10.1444,-7.534624 -3.08839,-3.143887 -1.96742,8.669595 -9.257824,4.086392 -4.070001,-2.084458 -6.789065,1.902235 -11.454296,-0.457587 -1.298293,-0.765742 -7.0231537,-1.694695 -3.7241037,1.63653 3.8200737,1.982083 7.6764837,3.493238 7.4521597,8.183059 -1.336792,3.46596 -3.391653,6.525796 1.417865,8.893755 3.392699,2.089275 4.523591,8.8944 -0.08353,10.496594 -4.757352,2.144845 -4.969497,4.271289 0.0043,3.949011 10.595238,0.410799 9.943925,0.983366 11.881513,2.556899 1.392606,2.457504 2.493064,2.839151 3.052523,2.720091 z",
        "m 44.884385,112.54461 c -3.928485,0.19241 -9.190929,-1.23904 -5.273314,-2.64436 1.283129,-1.46399 -2.672512,-4.09202 -6.471539,-4.32683 -1.358276,-1.84812 -1.200729,-5.02233 -6.559293,-4.96476 -2.944877,-0.694387 -4.15948,-2.582413 -7.82446,-5.499353 -3.452932,-2.456188 -4.747505,0.153034 -8.175029,-1.527687 1.502496,-3.243796 6.589911,-2.209786 9.06562,-2.75082 2.798941,-0.731691 6.526836,-0.597044 8.550457,0.684049 2.939473,1.914352 2.639008,-5.844444 6.101994,-1.714744 3.874341,9.070782 11.884117,16.761185 20.827794,20.666035 -1.868988,1.7573 -7.672119,1.84565 -10.24223,2.07847 z",
    ]
    etch_paths = [
        "m 42.643848,93.330029 c 0,-0.38868 0.07114,-0.43472 0.671838,-0.43472 0.797812,0 1.45056,-0.55803 1.797611,-1.53678 0.179343,-0.50577 0.225809,-4.17916 0.225809,-17.85168 0,-16.237383 -0.01799,-17.261492 -0.316796,-18.035893 -0.379873,-0.984488 -1.167218,-1.70035 -1.870141,-1.70035 -0.426284,0 -0.508321,-0.07016 -0.508321,-0.434719 v -0.434718 h 2.743433 2.743436 l 3.616412,15.7803 c 4.042505,17.63957 3.743862,16.3889 3.913439,16.3889 0.06908,0 0.571145,-1.97579 1.115692,-4.39066 0.54455,-2.41486 2.179418,-9.65293 3.633041,-16.0846 l 2.642952,-11.69394 h 2.750421 2.750423 v 0.434718 c 0,0.382424 -0.07459,0.434719 -0.620038,0.434719 -0.857776,0 -1.227907,0.240233 -1.683403,1.092613 l -0.391817,0.733208 v 17.475702 c 0,9.61164 0.06118,17.76353 0.135959,18.11532 0.07478,0.3518 0.360482,0.87998 0.6349,1.17375 0.400005,0.4282 0.64027,0.53411 1.211672,0.53411 0.644319,0 0.712727,0.0417 0.712727,0.43472 v 0.43472 h -4.173302 -4.173302 v -0.43472 c 0,-0.39299 0.06841,-0.43472 0.712729,-0.43472 0.872062,0 1.56146,-0.64525 1.89806,-1.7765 0.286203,-0.96188 0.477764,-31.957686 0.197506,-31.957686 -0.0971,0 -0.216471,0.136935 -0.265268,0.304303 -0.0488,0.167367 -1.81565,7.928063 -3.926335,17.245993 -2.110684,9.31794 -3.875767,16.97986 -3.922408,17.0265 -0.04664,0.0466 -0.122756,0.0468 -0.169148,5.3e-4 -0.04639,-0.0464 -1.807999,-7.65953 -3.914677,-16.91807 -4.477319,-19.677222 -3.996986,-17.659248 -4.203356,-17.659248 -0.272055,0 -0.0893,31.219618 0.187727,32.068558 0.340056,1.04209 1.057029,1.66563 1.915213,1.66563 0.640265,0 0.708927,0.0421 0.708927,0.43472 v 0.43472 h -3.390807 -3.390808 z",
        "m 70.118086,93.330029 c 0,-0.38932 0.07076,-0.43472 0.677537,-0.43472 0.555826,0 0.772943,-0.10866 1.208635,-0.60488 0.292106,-0.33269 0.593646,-0.9 0.670092,-1.26069 0.07645,-0.36069 0.138994,-8.32424 0.138994,-17.69678 0,-16.06916 -0.01807,-17.087803 -0.316797,-17.862003 -0.379872,-0.984488 -1.167214,-1.70035 -1.870141,-1.70035 -0.426283,0 -0.50832,-0.07016 -0.50832,-0.434719 v -0.434718 l 2.738729,5.29e-4 2.738731,5.29e-4 3.651639,15.924322 c 2.008401,8.75838 3.706071,16.01347 3.772601,16.12241 0.06653,0.10894 0.151016,0.16122 0.187753,0.11617 0.03674,-0.0451 1.652014,-7.12435 3.589499,-15.73179 1.937486,-8.607435 3.563403,-15.825943 3.61315,-16.041129 0.08913,-0.38553 0.130823,-0.391247 2.853799,-0.391247 h 2.76335 v 0.434718 c 0,0.392994 -0.06841,0.434718 -0.712729,0.434718 -0.936649,0 -1.618771,0.69777 -1.882002,1.925172 -0.260792,1.216033 -0.260792,34.058338 0,35.274368 0.263231,1.2274 0.945353,1.92517 1.882002,1.92517 0.644319,0 0.712729,0.0417 0.712729,0.43472 v 0.43472 h -4.173302 -4.173302 v -0.43472 c 0,-0.393 0.06841,-0.43472 0.712727,-0.43472 0.936649,0 1.618771,-0.69777 1.882002,-1.92517 0.239324,-1.11593 0.242936,-32.067409 0.0037,-31.54819 -0.08814,0.191275 -1.887924,7.97591 -3.999518,17.2992 -2.111597,9.32328 -3.873048,16.9852 -3.914336,17.02649 -0.04129,0.0413 -0.11684,0.0333 -0.167891,-0.0177 -0.05106,-0.0511 -1.77196,-7.47823 -3.824232,-16.50483 -2.052273,-9.02661 -3.818044,-16.783697 -3.923938,-17.237979 -0.105891,-0.454282 -0.267168,-0.825966 -0.358391,-0.825966 -0.275532,0 -0.08969,31.209915 0.191312,32.128705 0.30166,0.98633 1.048031,1.60548 1.93534,1.60548 0.611764,0 0.682207,0.0449 0.682207,0.43473 v 0.43471 H 73.508908 70.1181 Z",
    ]

    group.append(dw.Circle(70.85919, 73.611367, 40-1.6, stroke_width='1mm', stroke=laser.etch_style['fill'], fill='none'))
    for path_data in cut_paths:
        path_in_group = dw.Path(path_data, **laser.cut_style)
        group.append(path_in_group)
    for etch in etch_paths:
        group.append(dw.Path(etch, **laser.etch_style))

    d.append(group)

    # Compile SVG and write to disk
    d.append(g)
    d.save_svg('out.svg')

# Main
if __name__ == '__main__':
    make_card()
